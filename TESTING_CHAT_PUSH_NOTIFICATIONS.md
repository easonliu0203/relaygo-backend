# 聊天室推播通知測試指南

## 📋 測試前準備

### 1. 確認 Railway 部署狀態
1. 前往 Railway Dashboard: https://railway.app/dashboard
2. 找到 `relaygo-backend` 專案
3. 確認最新的部署已成功（綠色勾勾）
4. 檢查部署日誌，確認沒有錯誤

### 2. 確認環境變數
在 Railway 的 Variables 標籤中確認：
- ✅ `FIREBASE_PROJECT_ID` = `ride-platform-f1676`
- ✅ `FIREBASE_PRIVATE_KEY` = (完整的 private key)
- ✅ `FIREBASE_CLIENT_EMAIL` = (service account email)

### 3. 確認客戶端 App 設定
**客戶端 (Customer App)**:
- ✅ 已安裝最新版本
- ✅ 已登入帳號
- ✅ 已授權推播通知權限
- ✅ FCM Token 已儲存到 Firestore

**司機端 (Driver App)**:
- ✅ 已安裝最新版本
- ✅ 已登入帳號
- ✅ 已授權推播通知權限
- ✅ FCM Token 已儲存到 Firestore

---

## 🧪 測試案例

### 測試案例 1：客戶發送訊息給司機

#### 步驟
1. **客戶端操作**：
   - 開啟一個有司機的訂單
   - 進入聊天室
   - 發送訊息：「你好，請問幾點到？」

2. **司機端驗證**：
   - 確認收到推播通知
   - 通知標題應為：「新訊息」
   - 通知內容應為：「你好，請問幾點到？」
   - 點擊通知應導航到對應的聊天室

#### 預期結果
- ✅ 司機端收到推播通知
- ✅ 通知內容正確
- ✅ 點擊通知可正確導航

---

### 測試案例 2：司機發送訊息給客戶

#### 步驟
1. **司機端操作**：
   - 開啟一個訂單
   - 進入聊天室
   - 發送訊息：「我大約 10 分鐘後到達」

2. **客戶端驗證**：
   - 確認收到推播通知
   - 通知標題應為：「新訊息」
   - 通知內容應為：「我大約 10 分鐘後到達」
   - 點擊通知應導航到對應的聊天室

#### 預期結果
- ✅ 客戶端收到推播通知
- ✅ 通知內容正確
- ✅ 點擊通知可正確導航

---

### 測試案例 3：長訊息截斷

#### 步驟
1. 發送一條超過 50 字元的訊息：
   ```
   「您好，我是您的司機。我現在正在前往接送地點的路上，預計大約 15 分鐘後到達。如果有任何問題，請隨時與我聯繫。謝謝！」
   ```

2. 驗證接收方收到的通知

#### 預期結果
- ✅ 通知內容只顯示前 50 字元
- ✅ 結尾有 "..." 表示訊息被截斷
- ✅ 例如：「您好，我是您的司機。我現在正在前往接送地點的路上，預計大約 15 分鐘後到達。如果有任何問...」

---

### 測試案例 4：應用在背景時收到通知

#### 步驟
1. 將接收方 App 切換到背景（按 Home 鍵）
2. 發送方發送訊息
3. 驗證接收方收到系統推播通知

#### 預期結果
- ✅ 系統通知欄顯示推播通知
- ✅ 通知有聲音和震動（如果已開啟）
- ✅ 點擊通知可喚醒 App 並導航到聊天室

---

### 測試案例 5：應用完全關閉時收到通知

#### 步驟
1. 完全關閉接收方 App（從多工列表中滑掉）
2. 發送方發送訊息
3. 驗證接收方收到系統推播通知

#### 預期結果
- ✅ 系統通知欄顯示推播通知
- ✅ 點擊通知可啟動 App 並導航到聊天室

---

## 🔍 除錯方法

### 1. 檢查 Railway 日誌

在 Railway Dashboard 中查看部署日誌：

**成功的日誌範例**：
```
[FCM] 準備發送推播通知: { recipientId: 'abc123', type: 'new_message', title: '新訊息' }
[FCM] 找到 FCM Token: eF5x...
[FCM] ✅ 推播通知發送成功: projects/ride-platform-f1676/messages/0:1234567890
```

**失敗的日誌範例**：
```
[FCM] 用戶沒有 FCM Token，跳過推播: abc123
```
→ **解決方法**：確認客戶端已正確儲存 FCM Token 到 Firestore

```
[FCM] ❌ 推播通知發送失敗: Error: Invalid registration token
```
→ **解決方法**：FCM Token 可能已過期，需要客戶端重新獲取並儲存

---

### 2. 檢查 Firestore 中的 FCM Token

1. 前往 Firebase Console: https://console.firebase.google.com
2. 選擇專案：`ride-platform-f1676`
3. 進入 Firestore Database
4. 查看 `users/{userId}` 文檔
5. 確認 `fcmToken` 欄位存在且不為空

**正確的資料結構**：
```json
{
  "fcmToken": "eF5x1234567890abcdef...",
  "updatedAt": "2025-11-22T10:30:00Z",
  ...
}
```

---

### 3. 測試 FCM Token 是否有效

可以使用 Firebase Console 的 Cloud Messaging 測試工具：
1. 前往 Firebase Console → Cloud Messaging
2. 點擊「Send test message」
3. 輸入 FCM Token
4. 發送測試通知
5. 確認裝置收到通知

---

## ⚠️ 常見問題

### Q1: 沒有收到推播通知
**可能原因**：
1. FCM Token 沒有儲存到 Firestore
2. 推播通知權限未授權
3. FCM Token 已過期
4. Backend 環境變數設定錯誤

**解決方法**：
1. 檢查 Firestore 中是否有 `fcmToken`
2. 檢查 App 的通知權限設定
3. 重新登入 App 以獲取新的 Token
4. 檢查 Railway 環境變數

---

### Q2: 通知內容不正確
**可能原因**：
1. 訊息截斷邏輯有問題
2. 通知資料格式錯誤

**解決方法**：
1. 檢查 Railway 日誌中的通知內容
2. 確認 `ChatService.sendMessageNotification()` 的參數正確

---

### Q3: 點擊通知無法導航
**可能原因**：
1. 客戶端的通知處理邏輯有問題
2. 通知 data 欄位缺少必要資訊

**解決方法**：
1. 檢查客戶端的 `NotificationService` 實作
2. 確認通知 data 包含 `chatRoomId` 和 `bookingId`

---

## 📊 測試報告範本

### 測試日期：____________________
### 測試人員：____________________

| 測試案例 | 結果 | 備註 |
|---------|------|------|
| 客戶發送訊息給司機 | ☐ 通過 ☐ 失敗 | |
| 司機發送訊息給客戶 | ☐ 通過 ☐ 失敗 | |
| 長訊息截斷 | ☐ 通過 ☐ 失敗 | |
| 應用在背景時收到通知 | ☐ 通過 ☐ 失敗 | |
| 應用完全關閉時收到通知 | ☐ 通過 ☐ 失敗 | |

### 問題記錄：
```
(記錄測試過程中發現的問題)
```

### 建議改進：
```
(記錄改進建議)
```

---

## ✅ 測試完成檢查清單

- ☐ 所有測試案例都已執行
- ☐ 所有測試案例都通過
- ☐ Railway 日誌沒有錯誤
- ☐ Firestore 中的 FCM Tokens 都有效
- ☐ 已填寫測試報告
- ☐ 已向團隊報告測試結果

---

**測試完成後，請將此文檔和測試報告提交給開發團隊。**

